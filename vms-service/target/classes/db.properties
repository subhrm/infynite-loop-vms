sql.connectionCheck=select 1 from dual
sql.login=SELECT id, name, email, role_code FROM vms_users WHERE email=? AND password=?
sql.login.access=select v.visitor_type_cd, v.visitor_type_desc from vms_users u join role_visitor_access r on u.role_code=r.role_code join visitor_type v on r.visitor_type_cd=v.visitor_type_cd where u.id=?
sql.visitor.lastDays=SELECT COUNT(1) as count, visitor_date as date FROM ( SELECT id visitor_id, DATE_FORMAT(expected_in_time, '%Y-%m-%d') visitor_date FROM visitor WHERE DATE(expected_in_time) BETWEEN CURDATE()-7 AND CURDATE()-1) v GROUP BY visitor_date
sql.visitor.today=select inside, remaining, (inside + remaining) total from (select sum(inside) inside, sum(remaining) remaining from (select count(1) inside, 0 as remaining from visitor where status = 1 union select 0 as inside, count(1) remaining FROM visitor WHERE DATE(expected_in_time) = CURDATE() and status=0) a ) b
sql.visitor.profile=SELECT v.id visitor_id, t.visitor_type_desc visitor_type, v.name, v.email, v.mobile, i.image_data photo, e.name referred_by, DATE_FORMAT( expected_in_time, "%Y-%m-%d %H:%i:%s" ) expected_in_time, DATE_FORMAT(actual_in_time, "%Y-%m-%d %H:%i:%s") actual_in_time, DATE_FORMAT( expected_out_time, "%Y-%m-%d %H:%i:%s" ) expected_out_time, DATE_FORMAT( actual_out_time, "%Y-%m-%d %H:%i:%s" ) actual_out_time, v.status status, v.is_spot_registration FROM vms.visitor v JOIN vms.images i ON v.uploaded_photo = i.image_id JOIN vms.visitor_type t ON v.visitor_type_cd = t.visitor_type_cd LEFT OUTER JOIN vms.employee e ON v.refered_by = e.id WHERE v.id=?
sql.employee.family=select f.name, f.email, f.mobile, f.relation, f.photo photoId, i.image_data photo from employee_family f left outer join images i on f.photo=i.image_id where f.emp_id=?
sql.visitor.register=INSERT INTO visitor(visitor_type_cd, name, email, mobile, uploaded_photo, refered_by, expected_in_time, expected_out_time, status, is_spot_registration) VALUES ( ?, ?, ?, ?, ?, ?, str_to_date(?, '%Y-%m-%d %H:%i:%s'), str_to_date(?, '%Y-%m-%d %H:%i:%s'), ?, ?)
sql.visitor.approvedToday=SELECT v.id visitor_id, t.visitor_type_cd visitor_type, t.visitor_type_desc visitor_type_desc, v.name, e.name referred_by FROM visitor v JOIN visitor_type t ON v.visitor_type_cd = t.visitor_type_cd LEFT OUTER JOIN employee e ON v.refered_by = e.id WHERE v.status = 1
sql.image.fetch=select image_data from images where image_id=?
sql.visitor.approver.byEmpId=SELECT id, name, email, mobile FROM employee where id=?
sql.visitor.approver.byVType=SELECT e.id, e.name, e.email, e.mobile FROM employee e JOIN default_approver a ON e.id=a.emp_id where a.visitor_type_cd=?
sql.approver.eligibility=select v.id, v.status, v.refered_by, a.emp_id df_approver from visitor v left outer join default_approver a on v.visitor_type_cd=a.visitor_type_cd where v.id=?
sql.visitor.approve=update visitor set status=?, refered_by=? where id=?
sql.visitor.delete=delete from visitor where id=?
sql.employee.byEmpId=select e.id, e.name, e.email, e.mobile, e.photo photoId, i.image_data photo from employee e left outer join images i on e.photo=i.image_id where e.id=?
sql.visitor.inside=select v.id visitor_id, t.visitor_type_desc visitor_type, v.name, v.email, v.mobile, v.uploaded_photo photo_id, CONCAT(?, v.uploaded_photo) photo_url, DATE_FORMAT(v.actual_in_time, "%Y-%m-%d %H:%i:%s") actual_in_time, DATE_FORMAT(v.expected_out_time, "%Y-%m-%d %H:%i:%s") expected_out_time, v.status, e.name ref_name, e.mobile ref_mobile, concat(timediff(current_timestamp, v.expected_out_time), '') as time_exceed from visitor v join visitor_type t ON v.visitor_type_cd = t.visitor_type_cd left outer join employee e on v.refered_by=e.id where v.status=1 order by v.expected_out_time
sql.visitor.exceedOutTime=select id, name, mobile, DATE_FORMAT(expected_out_time, "%h:%i %p") expected_out_time from visitor where status=1 and expected_out_time < current_timestamp
sql.visitor.log.insert=insert into visitor_movement_log (visitor_id, location_id, event_type, event_time) select ? as visitor_id, location_id, ? as event_type, current_timestamp() as event_time from security where id=? limit 0,1
sql.images.insert=insert into images (image_data) values (?)
sql.visitor.approve.security=update visitor set actual_photo=?, actual_in_time=current_timestamp(), status=? where id=?
sql.visitor.finalExit=update visitor set status=?, actual_out_time=current_timestamp() where id=?
sql.visitor.updateStatus=update visitor set status=? where id=?
sql.visitor.allowedLocations=SELECT v.name, t.visitor_type_desc visitor_type, CONCAT(?, v.uploaded_photo) photo, l.description allowed_location, l.location_code FROM visitor v join visitor_type t on v.visitor_type_cd=t.visitor_type_cd join visitor_access a on v.visitor_type_cd=a.visitor_type_cd join security_locations l on a.location_code=l.location_code where v.status=1 and id=?
sql.security.location=select location_id from security where id=?
